<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>test</title>
<script src="js/render_api_basic.js"></script>
<link rel="stylesheet" type="text/css" href="css/api_basic.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Nanum+Myeongjo&display=swap');

body {
    font-family: sans-serif;
}

h1, h2 , h3 , h4 , h5 {
    font-family: "Nanum Myeongjo" , serif;
}
h1 {
    font-weight: bold;
}
h2 {
    margin-top: 100px;
    padding: 5px;
    background-color: #000;
    color: #eee;
    text-align: center;
}
h3 {
    margin-top: 70px;
    padding: 5px;
    border-bottom: #222 5px solid;
    text-align: center;
}
h4 {
    border-bottom: #222 3px dashed;
}
.hn {
    font-size: 60%;
}

table {
    width: 100%;
    border-spacing: 0px;
    border-collapse: collapse;
    background-color: white;
    font-family: sans-serif;
    color: black;
}
caption {
    padding: 6px 3px 3px 1px;
    text-align: center;
    font-family: "Nanum Gothic", sans-serif;
    font-weight: bold;
}
td , th {
    border: 1px solid black;
    padding: 1px 3px;
}

.code {
    font-family: Consolas, monospace;
}

</style>
</head>
<body>

<h1>연동규격서 만들기 TEST</h1>

<ul id="charye"
    style="
        padding: 10px;
        border: 1px dotted #444;
        list-style: none;
    "
></ul>

<div id="contents"></div>

<script>
const docEl_charye  = document.getElementById('charye');
const docEl_contents = document.getElementById('contents');

document.addEventListener('DOMContentLoaded', () => {
    fetch('content-data.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            try{
                contentsRender( data );
            }catch( err ){
                console.error('failed to contentsRender ... ', err);
            }
        })
        .catch(err => {
            console.error('failed to get data ... ', err);
            alert('failed to get data');
        });
});

const contentsRender = ( data )=>{
    if( !typeCheck( data, 'Array' ) ) return ;

    const hn = {
        n: 0,
        h2 : 0,
        h3 : 0,
        h4 : 0,
        h5 : 0,
        step : function( n ){
            if( n==null || n<2 || n>5 ) return ;

            this.n = n;

            if( n == 2 ){
                this.h5 = 0; this.h4 = 0; this.h3 = 0; this.h2 += 1;
            }else if(this.n== 3 ){
                this.h5 = 0; this.h4 = 0; this.h3 += 1;
            }else if(this.n== 4 ){
                this.h5 = 0; this.h4 += 1;
            }else if(this.n== 5 ){
                this.h5 += 1;
            }
        },
        toString : function( n ){
            if( n == null ) n = this.n;

            if(this.n=== 2 ){
                return `${this.h2}`;
            }else if(this.n=== 3 ){
                return `${this.h2}-${this.h3}`;
            }else if(this.n=== 4 ){
                return `${this.h2}-${this.h3}-${this.h4}`;
            }else if(this.n=== 5 ){
                return `${this.h2}-${this.h3}-${this.h4}-${this.h5}`;
            }
            return `${this.h2}-${this.h3}-${this.h4}-${this.h5}`;
        },
        toSpan : function(n){
            if( n == null ) n = this.n;

            return `<span class="hn hn${this.n}">${this.toString()}</span>`;
        },
        getSpan5 : function(){
            return `<span class="hn hn5">${this.h5}</span>`;
        }
    };

    let i = 0;
    let renderedBlock = '';
    for( const block of data ){
        i += 1;
        let renderedContent;

        const blockType = block.type;
        if( blockType == null ) continue;

        if( blockType === 'h2' ){
            hn.step(2);
            renderedContent = render_h( block.data , hn );
        }else if( blockType === 'h3' ){
            hn.step(3);
            renderedContent = render_h( block.data , hn );
        }else if( blockType === 'h4' ){
            hn.step(4);
            renderedContent = render_h( block.data , hn );
        }else{
            hn.step(5);
            if( blockType === 'api_basic' ){
                renderedContent = render_api_basic( block.data , hn );
            }else if( blockType === 'plainText' ){
                renderedContent = `<p>${rawText_to_html(block.data)}</p>`;
            }else{
                console.error('unknown blockType: '+blockType);
            }
        }

        renderedBlock += get_contentBlock( i, blockType, renderedContent );
        addCharye( block.data , hn , i );
    }
    docEl_contents.innerHTML = renderedBlock;
}

const addCharye = ( data , hn , i )=>{
    if( data.title != null ){
        docEl_charye.innerHTML += `
            <li><a href="#block-${i}">${hn.toString()}: ${data.title}</a></li>`;
    }
}

const get_contentBlock = ( i , blockType , renderedContent )=>{
    return `
        <div id="block-${i}" class="blockType-${blockType}">
            ${renderedContent}
        </div>`;
}

const render_h = ( data , hn )=>{
    return `<h${hn.n}>${hn.toSpan(hn.n)} ${data.title}</h${hn.n}>`;
}

const map_to_trs = ( obj ) => {
    if( !typeCheck( obj, 'object' ) ) return '';

    let result = '<tr>';
    for( const key in obj ){
        result += `<th>${key}</th><td>${obj[key]}</td>`;
    }
    result += '</tr>';
    return result ;
}

const rawText_to_html = ( text )=>{
    if( !typeCheck( text, 'string' ) ) return ;

    return text
        .replace(/\n/g, '<br>')// 줄바꿈
        .replace(/ {2,}/g, ( match )=>{// 띔
            return '&nbsp;'.repeat( match.length -1 ) + ' ';
        });
}

const combineStrFor = ( funfun , list )=>{
    if( !typeCheck( list, 'Array' ) ) return ;

    let result = '';
    for( const el of list ){
        result += funfun( el );
    }
    return result;
}

const notEmptyStr = ( text )=>{
    if( text == null ) return false;
    if( text == '' ) return false;
    return true;
}

const typeCheck = ( data , type , letsConsoleErr )=>{
    if( type == 'Array' ){
        if( Array.isArray( data ) ) return true;
    }else{
        if( typeof data === type ) return true;
    }

    if( letsConsoleErr == null || letsConsoleErr ) console.error(`data format error: this is not a ${type} ...`, data)

    return false;
}

</script>
</body>
</html>
